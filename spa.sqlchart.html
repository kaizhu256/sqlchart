<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>sqlchart editor</title>
<link rel="stylesheet" href="assets.bootstrap-v3.4.1.datatables-v1.10.21.chartjs-v2.9.4.codemirror-5.58.3.rollup.css">
<!-- <link rel="stylesheet" href="demo.css"> -->
<style>
/* jslint utility2:true */
/*csslint
    box-model: false,
    ids: false,
    important: false,
    overqualified-elements: false,
    qualified-headings: false,
*/
a,
a:focus,
a:hover {
    cursor: pointer;
    display: inline-block;
    text-decoration: none;
}
body {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
}
code,
pre,
textarea,
#datatables_buttons_info table tbody tr td:nth-child(1),
#panelContent1 .CodeMirror {
    font-family: Consolas, Menlo, monospace;
    font-size: 11px;
}
table {
    border-collapse: collapse !important;
    width: 100%;
}
table tbody tr td,
.dataTable tbody tr td,
.dataTable thead tr th {
    overflow: hidden;
    padding: 2px 2px 0 2px;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.button,
.button:focus,
.button:hover {
    border-radius: 3px;
    height: 20px;
    min-width: 50px;
}
#contextmenu1 {
    border: 1px solid;
    position: fixed;
    z-index: 99;
}
#contextmenu1 table tbody tr td,
#contextmenu1 table thead tr th {
    padding: 2px 5px 0 5px;
    white-space: nowrap;
}
#contextmenu1 table tbody tr td:nth-child(1) {
    padding-right: 0;
    white-space: nowrap;
}
#contextmenu1 table tbody tr[data-crud] {
    cursor: pointer;
}
#contextmenu1 table thead tr th,
#panelContent1 .title,
#panelSidebar1 table tbody tr td:nth-child(1),
#panelSidebar1 > div {
    text-align: center;
}
#datatables_buttons_info table tbody tr {
    display: none;
}
#datatables_buttons_info table tbody tr td {
    padding: 5px 0;
}
#datatables_buttons_info table tbody tr td input,
#datatables_buttons_info table tbody tr td select,
#datatables_buttons_info table tbody tr td span {
    display: inline-block;
    height: 20px;
    width: 100%;
}
#datatables_buttons_info table tbody tr td span {
    padding: 2px 2px 0 2px;
}
#datatables_buttons_info textarea {
    height: 150px;
    padding: 5px;
    width: 100%;
}
#datatables_buttons_info .loader {
    animation: loaderSpin 2s linear infinite;
    border: 10px solid #dde;
    border-radius: 50% !important;
    border-top: 10px solid #37f;
    height: 50px;
    left: 50%;
    top: 50%;
    width: 50px;
    z-index: 9999;
}
#datatables_buttons_info > div {
    padding: 10px;
}
#datatables_buttons_info > div > div {
    margin: 10px 0 0 0;
}
#datatables_buttons_info > div > div:nth-child(1) {
    margin: auto;
}
#datatables_buttons_info > h2 {
    font-size: 20px;
    padding: 5px;
}
#editor1 textarea {
    display: block;
    width: 100%;
}
#panelContent1 {
    padding: 0 20px 10px 170px;
}
#panelContent1 .CodeMirror {
    height: 400px;
    margin-bottom: 5px;
}
#panelContent1 .CodeMirror-scroll {
    overflow-x: auto;
    overflow-y: hidden;
}
#panelContent1 .dataTable {
    margin: 0;
}
#panelContent1 .dataTable tbody tr td,
#panelContent1 .dataTable thead tr th {
    border: 0;
    max-width: 400px;
    padding-right: 15px;
}
#panelContent1 .dataTables_info {
    padding-top: 2px;
}
#panelContent1 .sqlResultData {
    margin-top: 50px;
}
#panelContent1 .sqlResultData[data-t_type=index] {
    margin-top: 0;
}
#panelContent1 .sqlResultData[data-t_type=index] .title {
    text-align: left;
}
#panelContent1 .title {
    margin: 0;
    padding: 5px;
    width: 100%;
}
#panelSidebar1 {
    height: 100%;
    overflow-x: hidden;
    position: fixed;
    width: 150px;
}
#panelSidebar1 table {
    table-layout: fixed;
    width: 100%;
}
#panelSidebar1 table a,
#panelSidebar1 table a:focus,
#panelSidebar1 table a:hover {
    width: 100%;
}
#panelSidebar1 table tbody tr td:nth-child(1) {
    width: 15px;
}
#panelSidebar1 table tbody tr td:nth-child(2) {
    padding-left: 4px;
}
#panelSidebar1 table tbody tr[data-hashtag] {
    cursor: pointer;
    font-weight: normal;
}
#panelSidebar1 #tableDb1 tbody tr {
    border: 0;
}
#panelSidebar1 #tableDb1 tbody tr td {
    padding: 0;
}
#panelSidebar1 #tableDb1 tbody tr td button {
    text-align: left;
    width: 100%;
}
@keyframes loaderSpin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
/* validateLineSortedReset */
a,
a:focus,
a:hover,
#panelSidebar1 table tbody tr[data-hashtag] {
    color: #37f;
}
.button,
.button:focus,
.button:hover {
    border: 1px solid #999;
}
.button:hover,
#contextmenu1 tbody tr[data-crud]:hover,
#panelContent1 .dataTable tbody tr:hover,
#panelContent1 .title:hover,
#panelSidebar1 tbody tr[data-hashtag]:hover {
    background: #dde !important;
    box-shadow: 0 0 1px #000;
}
#contextmenu1 {
    background: #fff;
}
#contextmenu1 table tbody tr,
#contextmenu1 table thead tr th,
#panelContent1 .title,
#panelSidebar1 table tbody tr,
#panelSidebar1 table tbody tr td:nth-child(1),
#panelSidebar1 > div {
    border-bottom: 1px solid #bbb;
}
#datatables_buttons_info {
    border: 1px solid #777;
}
#datatables_buttons_info table tbody tr td span {
    background: #dde;
    border-right: 10px solid #fff;
}
#panelContent1 canvas,
#panelContent1 .CodeMirror {
    border: 1px solid #bbb;
}
#panelContent1 .dataTable tbody {
    color: #037;
}
#panelContent1 .dataTable tbody tr {
    background: transparent;
}
#panelContent1 .dataTable thead tr th {
    border-right: 1px solid #bbb;
}
#panelContent1 .dataTables_info {
    color: #777;
}
#panelContent1 .dataTables_scrollBody {
    background: #eee;
    border: 1px solid #bbb;
}
#panelContent1 .dataTables_scrollHead {
    border-left: 1px solid #bbb !important;
    border-right: 1px solid #bbb !important;
}
#panelContent1 .title {
    background: #dde;
    border: 1px solid #bbb;
}
#panelSidebar1 {
    border-right: 1px solid #777;
}
#panelSidebar1 table tbody tr td:nth-child(1) {
    background: #dde;
}
#panelSidebar1 table tbody tr[data-t_type=index] td:nth-child(1) {
    background: #eef;
}
</style>
</head>
<body>
<div style="display: none;">
    <input id="dbFile1" type="file">
    <input id="csvFile1" type="file">
    <table id="uiLoader1"><thead><tr><th></th></tr></thead></table>
</div>
<div id="contextmenu1" style="display: none;">
    <table>
    <thead><tr><th colspan="2">crud action</th></tr></thead>
    <tbody>
    <tr data-t_type="index" data-crud="rename">
        <td></td><td></td>
    </tr>
    <tr data-t_type="index"><td colspan="2">&nbsp;</td></tr>
    <tr data-t_type="index" data-crud="drop">
        <td></td><td></td>
    </tr>
    <tr data-t_type="result" data-crud="save to csv">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="rename">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="clone data">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="clone data, schema, index">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="save to csv">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table"><td colspan="2">&nbsp;</td></tr>
    <tr data-t_type="table" data-crud="rename column">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="add column">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table" data-crud="add index">
        <td></td><td></td>
    </tr>
    <tr data-t_type="table"><td colspan="2">&nbsp;</td></tr>
    <tr data-t_type="table" data-crud="drop">
        <td></td><td></td>
    </tr>
    </tbody>
    </table>
</div> <!-- #contextmenu1 -->
<div id="panelSidebar1">
    <div>database</div>
    <table id="tableDb1">
    <tbody>
    <tr>
        <td>D</td>
        <td><button class="button" id="dbRefresh1">database - refresh</button></td>
    </tr>
    <tr>
        <td>D</td>
        <td><button class="button" id="dbSave1">database - save</button></td>
    </tr>
    <tr>
        <td>D</td>
        <td><button class="button" id="dbOpen1">database - open</button></td>
    </tr>
    <tr>
        <td>T</td>
        <td>
            <button class="button" id="dbTableCreate1">table - create</button>
        </td>
    </tr>
    <tr>
        <td>C</td>
        <td><button class="button" id="csvOpen1">csv - open</button></td>
    </tr>
    </tbody>
    </table>
    <div>sql editor</div>
    <table>
    <tbody>
    <tr
        data-hashtag="editor1"
        data-t_type="editor"
        title="{ &quot;description&quot;: &quot;sql editor&quot; }">
        <td>E</td>
        <td>sql editor</td>
    </tr>
    </tbody>
    </table>
    <div>query results</div>
    <table id="sqlResultMeta1"><tbody></tbody></table>
    <div>tables and indices</div>
    <table id="sqlResultMeta2"><tbody></tbody></table>
</div> <!-- #panelSidebar1 -->
<div id="panelContent1">
    <div id="editor1">
    <div class="title">sql editor</div>
    <textarea>
DROP TABLE IF EXISTS employees;
DROP INDEX IF EXISTS idx_employees_id;
DROP INDEX IF EXISTS idx_employees_hired_on;
DROP TABLE IF EXISTS employees2;
CREATE TABLE employees( id          integer,  name    text,
                        designation text,     manager integer,
                        hired_on    date,     salary  integer,
                        commission  float,    dept    integer);
CREATE INDEX idx_employees_id ON employees(id);
CREATE INDEX idx_employees_hired_on ON employees(hired_on);
CREATE INDEX idx_employees_salary ON employees(salary);
    INSERT INTO employees VALUES (1,'JOHNSON','ADMIN',6,'1990-12-17',18000,NULL,4);
    INSERT INTO employees VALUES (2,'HARDING','MANAGER',9,'1998-02-02',52000,300,3);
    INSERT INTO employees VALUES (3,'TAFT','SALES I',2,'1996-01-02',25000,500,3);
    INSERT INTO employees VALUES (4,'HOOVER','SALES I',2,'1990-04-02',27000,NULL,3);
    INSERT INTO employees VALUES (5,'LINCOLN','TECH',6,'1994-06-23',22500,1400,4);
    INSERT INTO employees VALUES (6,'GARFIELD','MANAGER',9,'1993-05-01',54000,NULL,4);
    INSERT INTO employees VALUES (7,'POLK','TECH',6,'1997-09-22',25000,NULL,4);
    INSERT INTO employees VALUES (8,'GRANT','ENGINEER',10,'1997-03-30',32000,NULL,2);
    INSERT INTO employees VALUES (9,'JACKSON','CEO',NULL,'1990-01-01',75000,NULL,4);
    INSERT INTO employees VALUES (10,'FILLMORE','MANAGER',9,'1994-08-09',56000,NULL,2);
SELECT * FROM (VALUES
    ('#!sqlchart','{"chartType":"bar"}'),
    (NULL, NULL),
    ('x', 'SELECT name FROM employees ORDER BY name'),
    ('y', 'SELECT ''employee'' AS label, salary FROM employees ORDER BY name')
);
SELECT * FROM (VALUES
    ('#!sqlchart','{"chartType":"line","xType":"time"}'),
    (NULL, NULL),
    ('xy', 'SELECT designation, hired_on, salary FROM employees ORDER BY designation, hired_on')
);
SELECT designation, COUNT(*) AS nbr, (AVG(salary)) AS avg_salary
    FROM employees GROUP BY designation ORDER BY avg_salary DESC;
CREATE TABLE employees2 AS SELECT a.name, a.designation
    FROM employees AS a CROSS JOIN employees;
INSERT INTO employees2 (name, designation) SELECT a.name, a.designation
    FROM employees2 AS a CROSS JOIN employees2;
SELECT * FROM employees2;</textarea>
    <button class="button" id="dbExec1">sql editor - execute</button>
    </div> <!-- #editor1 -->
    <div id="sqlResultData1"></div>
    <div id="sqlResultData2"></div>
</div> <!-- #panelContent1 -->
<script src="assets.bootstrap-v3.4.1.datatables-v1.10.21.chartjs-v2.9.4.codemirror-5.58.3.rollup.js"></script>
<script>
/* jslint utility2:true */
window.addEventListener("load", async function () {
    "use strict";
    let {
        $,
        Blob,
        Chart,
        CodeMirror,
        contextmenuDataset,
        onDbCrud,
        onDbRefresh,
        sqlCallbackDict,
        sqlCallbackId,
        sqlEditor,
        sqlPostMessage,
        sqlResultDict,
        sqlWorker,
        uiLoaderInfo,
        uiLoaderInfo0,
        uiRenderSqlResultTableIi
    } = window;
    // init debugInline
    if (!globalThis.debugInline) {
        let consoleError;
        consoleError = console.error;
        globalThis.debugInline = function (...argList) {
        /*
         * this function will both print <argList> to stderr and
         * return <argList>[0]
         */
            consoleError("\n\ndebugInline");
            consoleError(...argList);
            consoleError("\n");
            return argList[0];
        };
    }

    function assertOrThrow(passed, msg) {
    /*
     * this function will throw <msg> if <passed> is falsy
     */
        if (passed) {
            return;
        }
        throw (
            (
                msg &&
                typeof msg.message === "string" &&
                typeof msg.stack === "string"
            )
            // if msg is err, then leave as is
            ? msg
            : new Error(
                typeof msg === "string"
                // if msg is string, then leave as is
                ? msg
                // else JSON.stringify(msg)
                : JSON.stringify(msg, undefined, 4)
            )
        );
    }

    function domStyleValidate() {
    /*
     * this function will validate <style> tags
     */
        let list;
        let rgx;
        rgx = (
            /^0\u0020(?:(body\u0020>\u0020)?(?:\.test-report-div\u0020.+|\.x-istanbul\u0020.+|\.button|\.styleColorError|\.readonly|\.textarea|\.uiAnimateSlide|a|body|code|div|input|pre|textarea)(?:,|\u0020\{))|^[1-9]\d*?\u0020#/m
        );
        list = [];
        document.querySelectorAll("style").forEach(function (elem, ii) {
            elem.innerHTML.replace((
                /\/\*[\S\s]*?\*\/|;|\}/g
            ), "\n").replace((
                /^([^\n\u0020@].*?)[,{:].*?$/gm
            ), function (match0, match1) {
                try {
                    ii = document.querySelectorAll(match1).length;
                } catch (errCaught) {
                    console.error(errCaught);
                }
                if (!(ii > 1) && !rgx.test(elem)) {
                    list.push(ii + " " + match0);
                }
            });
        });
        list.filter(function (elem) {
            return !rgx.test(elem);
        }).sort().reverse().forEach(function (elem, ii, list) {
            console.error(
                "domStyleValidateUnmatched " + (list.length - ii) + ". " + elem
            );
        });
    }

    function jsonHtmlSafe(obj) {
    /*
     * this function will make <obj> html-safe
     * https://stackoverflow.com/questions/7381974/which-characters-need-to-be-escaped-on-html
     */
        return JSON.parse(JSON.stringify(obj).replace((
            /&/gu
        ), "&amp;").replace((
            /'/gu
        ), "&apos;").replace((
            /</gu
        ), "&lt;").replace((
            />/gu
        ), "&gt;").replace((
            /&amp;(amp;|apos;|gt;|lt;|quot;)/igu
        ), "&$1"));
    }

    function jsonRowListFromCsv({
        csv
    }) {
    /*
     * this function will convert <csv>-text to json list-of-list
     */
/*
https://tools.ietf.org/html/rfc4180#section-2
Definition of the CSV Format
    While there are various specifications and implementations for the
    CSV format (for ex. [4], [5], [6] and [7]), there is no formal
    specification in existence, which allows for a wide variety of
    interpretations of CSV files.  This section documents the format that
    seems to be followed by most implementations:
1.  Each record is located on a separate line, delimited by a line
    break (CRLF).  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
2.  The last record in the file may or may not have an ending line
    break.  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx
3.  There maybe an optional header line appearing as the first line
    of the file with the same format as normal record lines.  This
    header will contain names corresponding to the fields in the file
    and should contain the same number of fields as the records in
    the rest of the file (the presence or absence of the header line
    should be indicated via the optional "header" parameter of this
    MIME type).  For example:
    field_name,field_name,field_name CRLF
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
4.  Within the header and each record, there may be one or more
    fields, separated by commas.  Each line should contain the same
    number of fields throughout the file.  Spaces are considered part
    of a field and should not be ignored.  The last field in the
    record must not be followed by a comma.  For example:
    aaa,bbb,ccc
5.  Each field may or may not be enclosed in double quotes (however
    some programs, such as Microsoft Excel, do not use double quotes
    at all).  If fields are not enclosed with double quotes, then
    double quotes may not appear inside the fields.  For example:
    "aaa","bbb","ccc" CRLF
    zzz,yyy,xxx
6.  Fields containing line breaks (CRLF), double quotes, and commas
    should be enclosed in double-quotes.  For example:
    "aaa","b CRLF
    bb","ccc" CRLF
    zzz,yyy,xxx
7.  If double-quotes are used to enclose fields, then a double-quote
    appearing inside a field must be escaped by preceding it with
    another double quote.  For example:
    "aaa","b""bb","ccc"
*/
        let csvRowList;
        let match;
        let quote;
        let rgx;
        let row;
        let val;
        // normalize "\r\n" to "\n"
        csv = csv.replace((
            /\r\n?/gu
        ), "\n");
        rgx = (
            /(.*?)(""|"|,|\n)/gu
        );
        csvRowList = [];
        // reset row
        row = [];
        val = "";
        while (true) {
            match = rgx.exec(csv);
            if (!match) {
/*
2.  The last record in the file may or may not have an ending line
    break.  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx
*/
                if (!row.length) {
                    break;
                }
                // if eof missing crlf, then mock it
                rgx.lastIndex = csv.length;
                match = [
                    "\n", "", "\n"
                ];
            }
            // build val
            val += match[1];
            if (match[2] === "\"") {
/*
5.  Each field may or may not be enclosed in double quotes (however
    some programs, such as Microsoft Excel, do not use double quotes
    at all).  If fields are not enclosed with double quotes, then
    double quotes may not appear inside the fields.  For example:
    "aaa","bbb","ccc" CRLF
    zzz,yyy,xxx
*/
                quote = !quote;
            } else if (quote) {
/*
7.  If double-quotes are used to enclose fields, then a double-quote
    appearing inside a field must be escaped by preceding it with
    another double quote.  For example:
    "aaa","b""bb","ccc"
*/
                if (match[2] === "\"\"") {
                    val += "\"";
/*
6.  Fields containing line breaks (CRLF), double quotes, and commas
    should be enclosed in double-quotes.  For example:
    "aaa","b CRLF
    bb","ccc" CRLF
    zzz,yyy,xxx
*/
                } else {
                    val += match[2];
                }
            } else if (match[2] === ",") {
/*
4.  Within the header and each record, there may be one or more
    fields, separated by commas.  Each line should contain the same
    number of fields throughout the file.  Spaces are considered part
    of a field and should not be ignored.  The last field in the
    record must not be followed by a comma.  For example:
    aaa,bbb,ccc
*/
                // delimit val
                row.push(val);
                val = "";
            } else if (match[2] === "\n") {
/*
1.  Each record is located on a separate line, delimited by a line
    break (CRLF).  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
*/
                // delimit val
                row.push(val);
                val = "";
                // append row
                csvRowList.push(row);
                // reset row
                row = [];
            }
        }
        // append row
        if (row.length) {
            csvRowList.push(row);
        }
        return csvRowList;
    }

    function jsonRowListNormalize({
        colList,
        colListPriority = [],
        rowList
    }) {
    /*
     * this function will normalize <rowList> with given <colList>
     */
        // convert list-of-dict to list-of-list
        if (!Array.isArray(rowList[0])) {
            colList = new Map(Array.from(
                colList || []
            ).map(function (key, ii) {
                return [
                    key, ii
                ];
            }));
            rowList = rowList.map(function (row) {
                Object.keys(row).forEach(function (key) {
                    if (!colList.has(key)) {
                        colList.set(key, colList.size);
                    }
                });
                return Array.from(colList.keys()).map(function (key) {
                    return row[key];
                });
            });
            colList = Array.from(colList.keys());
        }
        if (!colList) {
            colList = rowList[0];
            rowList = rowList.slice(1);
        }
        // normalize rowList
        rowList = rowList.map(function (row) {
            return (
                row.length === colList.length
                ? row
                : colList.map(function (ignore, ii) {
                    return row[ii];
                })
            );
        });
        // sort colList by colListPriority
        if (!colListPriority) {
            return {
                colList,
                rowList
            };
        }
        colListPriority = new Map([].concat(
            colListPriority,
            colList
        ).map(function (key) {
            return [
                key, colList.indexOf(key)
            ];
        }).filter(function ([
            ignore, ii
        ]) {
            return ii >= 0;
        }));
        colList = Array.from(colListPriority.keys());
        colListPriority = Array.from(colListPriority.values());
        rowList = rowList.map(function (row) {
            return colListPriority.map(function (ii) {
                return row[ii];
            });
        });
        return {
            colList,
            rowList
        };
    }

    function jsonRowListToCsv({
        colList,
        colListPriority = [],
        rowList
    }) {
    /*
     * this function will convert <rowList> to csv-text
     */
/*
https://tools.ietf.org/html/rfc4180#section-2
Definition of the CSV Format
    While there are various specifications and implementations for the
    CSV format (for ex. [4], [5], [6] and [7]), there is no formal
    specification in existence, which allows for a wide variety of
    interpretations of CSV files.  This section documents the format that
    seems to be followed by most implementations:
1.  Each record is located on a separate line, delimited by a line
    break (CRLF).  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
2.  The last record in the file may or may not have an ending line
    break.  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx
3.  There maybe an optional header line appearing as the first line
    of the file with the same format as normal record lines.  This
    header will contain names corresponding to the fields in the file
    and should contain the same number of fields as the records in
    the rest of the file (the presence or absence of the header line
    should be indicated via the optional "header" parameter of this
    MIME type).  For example:
    field_name,field_name,field_name CRLF
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
4.  Within the header and each record, there may be one or more
    fields, separated by commas.  Each line should contain the same
    number of fields throughout the file.  Spaces are considered part
    of a field and should not be ignored.  The last field in the
    record must not be followed by a comma.  For example:
    aaa,bbb,ccc
5.  Each field may or may not be enclosed in double quotes (however
    some programs, such as Microsoft Excel, do not use double quotes
    at all).  If fields are not enclosed with double quotes, then
    double quotes may not appear inside the fields.  For example:
    "aaa","bbb","ccc" CRLF
    zzz,yyy,xxx
6.  Fields containing line breaks (CRLF), double quotes, and commas
    should be enclosed in double-quotes.  For example:
    "aaa","b CRLF
    bb","ccc" CRLF
    zzz,yyy,xxx
7.  If double-quotes are used to enclose fields, then a double-quote
    appearing inside a field must be escaped by preceding it with
    another double quote.  For example:
    "aaa","b""bb","ccc"
*/
        // handle null-case
        if (!rowList.length) {
            return "";
        }
        // normalize colList, rowList
        rowList = jsonRowListNormalize({
            colList,
            colListPriority,
            rowList
        });
        rowList.rowList.unshift(rowList.colList);
        rowList = rowList.rowList;
        return rowList.map(function (row) {
            return row.map(function (val) {
                if (val === undefined || val === null) {
                    return "";
                }
                if (typeof val === "string") {
/*
7.  If double-quotes are used to enclose fields, then a double-quote
    appearing inside a field must be escaped by preceding it with
    another double quote.  For example:
    "aaa","b""bb","ccc"
*/
                    val = val.replace((
                        /"/gu
                    ), "\"\"");
/*
6.  Fields containing line breaks (CRLF), double quotes, and commas
    should be enclosed in double-quotes.  For example:
    "aaa","b CRLF
    bb","ccc" CRLF
    zzz,yyy,xxx
*/
                    if ((
                        /[\r\n",]/
                    ).test(val)) {
                        val = "\"" + val + "\"";
                    }
                    return val;
                }
                return String(val);
/*
4.  Within the header and each record, there may be one or more
    fields, separated by commas.  Each line should contain the same
    number of fields throughout the file.  Spaces are considered part
    of a field and should not be ignored.  The last field in the
    record must not be followed by a comma.  For example:
    aaa,bbb,ccc
*/
/*
1.  Each record is located on a separate line, delimited by a line
    break (CRLF).  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx CRLF
*/
/*
2.  The last record in the file may or may not have an ending line
    break.  For example:
    aaa,bbb,ccc CRLF
    zzz,yyy,xxx
*/
            }).join(",") + "\r\n";
        }).join("");
    }

    function jsonRowListUnnormalize({
        colList,
        rowList
    }) {
    /*
     * this function will convert <rowList> from list-of-list to list-of-dict
     */
        let dict;
        let ii;
        let jj;
        let row;
        let rowList2;
        rowList2 = [];
        ii = 0;
        while (ii < rowList.length) {
            dict = {};
            row = rowList[ii];
            jj = 0;
            while (jj < row.length) {
                dict[colList[jj]] = row[jj];
                jj += 1;
            }
            rowList2.push(dict);
            ii += 1;
        }
        return rowList2;
    }

    function noop() {
    /*
     * this function will do nothing
     */
        return;
    }

    function sqlOnMessage({
        data
    }) {
    /*
     * this function will hande <data>-response from <sqlWorker>
     */
        sqlCallbackDict[data.id](data);
    }

    function stringHtmlSafe(str) {
    /*
     * this function will make <str> html-safe
     * https://stackoverflow.com/questions/7381974/which-characters-need-to-be-escaped-on-html
     */
        return str.replace((
            /&/gu
        ), "&amp;").replace((
            /"/gu
        ), "&quot;").replace((
            /'/gu
        ), "&apos;").replace((
            /</gu
        ), "&lt;").replace((
            />/gu
        ), "&gt;").replace((
            /&amp;(amp;|apos;|gt;|lt;|quot;)/igu
        ), "&$1");
    }

    function stringRegexpEscape(str) {
    /*
     * this function will regexp-escape <str>
     * https://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
     */
        return str.replace((
            /[\-\/\\\^$*+?.()|\[\]{}]/g
        ), "\\$&");
    }

    function stringSqlnameSafe(str) {
    /*
     * this function will make <str> sqlname-safe
     */
        return str.toLowerCase().trim().replace((
            /[^0-9_a-z]/g
        ), "_").replace((
            /^[0-9]/g
        ), "a$&");
    }

    function uiHashtagScrollto({
        target
    }) {
    /*
     * this function will scrollto <target>'s hashtag
     */
        let hashtag;
        try {
            hashtag = target.closest("[data-hashtag]").dataset.hashtag;
        } catch (ignore) {
            return;
        }
        location.hash = hashtag || "";
    }

    function uiLoaderEnd({
        key,
        modeForce,
        type
    }) {
    /*
     * this function will end ui-loading-animation
     */
        if (type) {
            if (type === "keydown" && key === "Escape") {
                uiLoaderEnd({
                    modeForce: true
                });
            }
            return;
        }
        if (modeForce) {
            uiLoaderInfo = uiLoaderInfo0;
        }
        uiLoaderInfo(false);
    }

    function uiLoaderStart({
        msg,
        modeForce
    }) {
    /*
     * this function will start ui-loading-animation
     */
        if (modeForce || !document.querySelector("#datatables_buttons_info")) {
            uiLoaderInfo(
                msg || "loading",
                "<div class=\"loader\"><\/div>"
            );
        }
    }

    function uiRenderError(err, mode) {
    /*
     * this function will ui-render <err>
     */
        // if err is function, wrap in try-catch-block
        if (typeof err === "function") {
            return function (...argList) {
                return err(...argList).catch(uiRenderError);
            };
        }
        // err - confirm
        if (mode === "modeConfirm") {
            uiLoaderEnd({
                modeForce: true
            });
            return;
        }
        // err - debug
        console.error(err);
        // err - ui-render
        uiLoaderInfo(
            "<div style=\"color: #d00;\">sql error<\/div>",
            (`
<div style="color: #d00;">${stringHtmlSafe(err.message)}<\/div><br>
<button
    class="button"
    onclick="window.uiRenderError(undefined,&quot;modeConfirm&quot;);"
>ok<\/button>
            `)
        );
        uiLoaderInfo = noop;
        return new Promise(function (ignore, reject) {
            setTimeout(function () {
                reject(err);
            });
        });
    }

    function uiRenderSqlResultIi({
        htmlData,
        htmlMeta,
        sqlResultIi,
        tableList
    }) {
    /*
     * this function will ui-render <tableList>
     */
        // cleanup sqlResultDict
        Object.keys(sqlResultDict).forEach(function (key) {
            if (key.indexOf("sqlResult-" + sqlResultIi + "-") === 0) {
                delete sqlResultDict[key];
            }
        });
        htmlData = "";
        htmlMeta = "";
        // ui-render - static-html
        tableList.forEach(function (table, ii) {
            let {
                colList,
                description,
                hashtag,
                rowcount,
                t_name,
                t_sql = "",
                t_type,
                tbl_name,
                title
            } = table;
            t_type = t_type || "result";
            description = (
                t_type === "index"
                ? " I" + (ii + 1) + " - " + tbl_name + " . " + t_name
                : t_type === "table"
                ? "T" + (ii + 1) + " - " + t_name
                : "R" + (ii + 1) + " - result"
            );
            hashtag = "sqlResult-" + sqlResultIi + "-" + ii;
            sqlResultDict[hashtag] = table;
            Object.assign(table, {
                description,
                hashtag,
                t_type
            });
            title = {
                description: description ?? undefined,
                rowcount: rowcount ?? undefined,
                columns: colList ?? undefined,
                sql: t_sql.replace((
                    /\s+/g
                ), " ").slice(0, 100) || undefined
            };
            title = JSON.stringify(title, undefined, 1);
            htmlData += (`
<div class="sqlResultData" data-t_type="${t_type}" id="${hashtag}">
    <div class="title">${stringHtmlSafe(description)}<\/div>
    <table><\/table>
    <div style="position: relative;">
    <button
        class="chartResetZoom"
        style="display: none; position: absolute;"
    >reset zoom<\/button>
    <canvas style="display: none;"><\/canvas>
    <\/div>
<\/div>
            `);
            htmlMeta += (`
<tr
    data-hashtag="${hashtag}"
    data-t_type="${t_type}" title="${stringHtmlSafe(title)}"
>
    <td>${t_type[0].toUpperCase()}<\/td>
    <td>${stringHtmlSafe(description).replace((/\u0020/g), "&nbsp;")}<\/td>
<\/tr>
            `);
        });
        document.querySelector(
            "#sqlResultData" + sqlResultIi
        ).innerHTML = htmlData;
        document.querySelector(
            "#sqlResultMeta" + sqlResultIi + " tbody"
        ).innerHTML = htmlMeta;
        // ui-render - datatable and chart
        return Promise.all(Array.from(document.querySelectorAll(
            "#sqlResultData" + sqlResultIi + " .sqlResultData"
        )).map(function (elem, ii) {
            uiRenderSqlResultTableIi(Object.assign({
                elem,
                sqlResultIi
            }, tableList[ii]));
        }));
    }

    uiRenderSqlResultTableIi = uiRenderError(async function zqjx1({
        ajax,
        chart,
        colList,
        elem,
        promise2,
        resolve2,
        rowList,
        sqlResultIi,
        t_type,
        tbl_name
    }) {
    /*
     * this function will ui-render datatable and chart
     */
        ajax = uiRenderError(async function ({
            draw,
            length,
            order,
            start
        }, callback) {
            let colIi;
            let data;
            colIi = order[0].column;
            if (sqlResultIi === 1) {
                rowList.sort(function (aa, bb) {
                    aa = aa[colIi];
                    bb = bb[colIi];
                    return (
                        aa < bb
                        ? -1
                        : aa > bb
                        ? 1
                        : 0
                    );
                });
                if (order[0].dir === "desc") {
                    rowList.reverse();
                }
                callback({
                    data: jsonHtmlSafe(
                        rowList.slice(start, start + length)
                    ),
                    draw,
                    recordsFiltered: rowList.length,
                    recordsTotal: rowList.length
                });
                return;
            }
            data = await sqlPostMessage({
                sql: (
                    "SELECT COUNT(*) FROM \"" + tbl_name + "\";\n" +
                    "SELECT rowid, * FROM \"" + tbl_name + "\"\n" +
                    "ORDER BY \"" + colList[colIi] + "\"\n" +
                    (
                        order[0].dir === "asc"
                        ? "ASC"
                        : "DESC"
                    ) + "\n" +
                    "LIMIT " + Number(length) + "\n" +
                    "OFFSET " + Number(start) + ";\n"
                )
            });
            callback({
                data: (
                    data.tableList[1]
                    ? jsonHtmlSafe(data.tableList[1].rowList)
                    : []
                ),
                draw,
                recordsFiltered: data.tableList[0].rowList[0][0],
                recordsTotal: data.tableList[0].rowList[0][0]
            });
            if (draw === 1) {
                resolve2();
                return;
            }
            uiLoaderEnd({});
        });
        if (t_type === "index") {
            return;
        }
        promise2 = new Promise(function (resolve) {
            resolve2 = resolve;
        });
        if (sqlResultIi === 2) {
            colList.unshift("rowid");
        }
        // ui-render datatable
        $(elem.querySelector("table")).datatable({
            ajax,
            columns: colList.map(function (name) {
                return {
                    defaultContent: "",
                    name,
                    title: name
                };
            }),
            data: rowList,
            // dom: "lfrtip",
            dom: "rti",
            pageLength: 100,
            scrollX: true,
            scrollY: 200,
            scroller: true,
            searching: false,
            serverSide: true
        });
        if (!(
            t_type === "result" &&
            rowList.length >= 3 &&
            rowList[0][0] === "#!sqlchart" &&
            JSON.stringify(rowList[1]) === "[null,null]"
        )) {
            return promise2;
        }
        // ui-render chart
        let {
            chartTitle,
            chartType,
            datasets = [],
            label0,
            xData,
            xLabel,
            xType,
            yLabel
        } = JSON.parse(rowList[0][1]);
        elem.querySelector(".chartResetZoom").style.display = "block";
        elem.querySelector("canvas").style.display = "block";
        await Promise.all(rowList.slice(2).map(async function ([
            key, sql
        ]) {
            let data;
            switch (key) {
            case "x":
            case "xy":
            case "y":
                data = await sqlPostMessage({
                    sql
                });
                data = Object.assign({
                    colList: [],
                    rowList: []
                }, data.tableList[0]);
                switch (key) {
                case "x":
                    xData = data.rowList.flat();
                    xLabel = data.colList[0];
                    return;
                case "xy":
                    xLabel = data.colList[1];
                    yLabel = data.colList[2];
                    break;
                case "y":
                    yLabel = data.colList[1];
                    break;
                }
                data.rowList.forEach(function ([
                    label, x, y
                ]) {
                    if (label0 !== label) {
                        data = [];
                        datasets.push({
                            borderWidth: 0,
                            data,
                            fill: false,
                            label,
                            lineTension: 0,
                            pointRadius: 0
                        });
                        label0 = label;
                    }
                    data.push(
                        key === "xy"
                        ? {
                            x,
                            y
                        }
                        : x
                    );
                });
                break;
            }
        }));
        elem.querySelector("canvas").style.height = (
            (10 * datasets.length + 400) +
            "px"
        );
        chart = new Chart(elem.querySelector("canvas"), {
            data: {
                datasets,
                labels: xData
            },
            options: {
                animation: {
                    duration: 0
                },
                maintainAspectRatio: false,
                plugins: {
                    zoom: {
                        zoom: {
                            drag: {
                                animationDuration: 500
                            },
                            enabled: true,
                            mode: "x"
                        }
                    }
                },
                scales: {
                    xAxes: [
                        {
                            distribution: "series",
                            scaleLabel: {
                                display: true,
                                labelString: xLabel
                            },
                            type: xType
                            // offset: true,
                            //!! ticks: {
                                //!! major: {
                                    //!! enabled: true
                                //!! },
                                //!! source: "data",
                                //!! autoSkip: true
                            // autoSkipPadding: 75,
                            // maxRotation: 0,
                            // sampleSize: 100
                            //!! }
                        }
                    ],
                    yAxes: [
                        {
                            gridLines: {
                                drawBorder: false
                            },
                            scaleLabel: {
                                display: true,
                                labelString: yLabel
                            }
                        }
                    ]
                },
                title: {
                    display: true,
                    text: chartTitle || (yLabel + " vs. " + xLabel)
                },
                tooltips: {
                    intersect: false,
                    mode: "index"
                }
            },
            type: chartType
        });
        // bug-workaround - init resetZoom
        chart.resetZoom();
        elem.querySelector(".chartResetZoom").addEventListener(
            "click",
            chart.resetZoom.bind(chart)
        );
        return promise2;
    });

/* validateLineSortedReset */
    sqlPostMessage = uiRenderError(async function sqlPostMessage({
        action = "exec",
        data,
        params,
        sql
    }) {
    /*
     * this function will post msg to <sqlWorker> and return result
     */
        let err;
        let id;
        let timeElapsed;
        uiLoaderStart({});
        timeElapsed = Date.now();
        sqlCallbackId += 1;
        id = sqlCallbackId;
        sqlWorker.postMessage({
            action,
            buffer: data,
            id,
            params,
            sql
        });
        err = new Error();
        err.msg = {
            action,
            data,
            params,
            sql
        };
        let {
            buffer,
            error,
            results = []
        } = await new Promise(function (resolve) {
            sqlCallbackDict[sqlCallbackId] = resolve;
        });
        delete sqlCallbackDict[id];
        timeElapsed = Date.now() - timeElapsed;
        console.error(
            "sqlPostMessage - " + JSON.stringify({
                action,
                timeElapsed
            })
        );
        if (error) {
            throw (Object.assign(err, {
                message: error,
                timeElapsed
            }));
        }
        results = results.map(function ({
            columns,
            values
        }) {
            return {
                colList: columns,
                rowList: values,
                sql
            };
        });
        return {
            buffer,
            sql,
            tableList: results
        };
    });

    function onContextmenu(evt) {
    /*
     * this function will hande contextmenu-evt
     */
        let elemCm;
        let {
            clientX,
            clientY,
            ctrlKey,
            metaKey,
            shiftKey,
            target,
            type
        } = evt;
        elemCm = document.querySelector("#contextmenu1");
        // contextmenu - onclick
        if (type !== "contextmenu") {
            // contextmenu - hide
            elemCm.style.display = "none";
            // contextmenu - run crud
            target = target.closest("#contextmenu1 tr[data-t_type]");
            if (contextmenuDataset && target) {
                onDbCrud(Object.assign(
                    {},
                    sqlResultDict[contextmenuDataset.hashtag],
                    target.dataset
                ));
            }
            return;
        }
        // contextmenu - oncontextmenu
        // contextmenu - enable default
        if (ctrlKey || metaKey || shiftKey) {
            return;
        }
        // contextmenu - disable default
        evt.preventDefault();
        evt.stopPropagation();
        target = target.closest(
            "#panelSidebar1 tbody tr[data-t_type]"
        );
        // contextmenu - hide
        if (!target) {
            elemCm.style.display = "none";
            return;
        }
        // init contextmenuDataset
        contextmenuDataset = target.dataset;
        elemCm.querySelectorAll("tr[data-t_type]").forEach(function ({
            children,
            dataset,
            style
        }) {
            style.display = "none";
            if (
                dataset.t_type && dataset.t_type === contextmenuDataset.t_type
            ) {
                style.display = "table-row";
                if (dataset.crud) {
                    children[0].textContent = dataset.t_type;
                    children[1].textContent = " - " + dataset.crud;
                }
            }
        });
        elemCm.style.left = Math.min(
            clientX,
            window.innerWidth - elemCm.offsetWidth - 10
        ) + "px";
        elemCm.style.top = Math.min(
            clientY,
            window.innerHeight - elemCm.offsetHeight - 20
        ) + "px";
        // contextmenu - show
        elemCm.style.display = "block";
    }

    async function onCsvOpen({
        target
    }) {
    /*
     * this function will open csv-file and load into db
     */
        let colList;
        let rowList;
        let set;
        if (target.type !== "file") {
            document.querySelector("#csvFile1").value = "";
            document.querySelector("#csvFile1").click();
            return;
        }
        // if (target.files.length === 0) {
        //     return;
        // }
        uiLoaderStart({});
        rowList = await target.files[0].text();
        rowList = jsonRowListFromCsv({
            csv: rowList
        });
        set = new Set();
        colList = rowList.shift().map(function (col) {
            let col2;
            let ii;
            ii = 0;
            // sanitize col
            col = stringSqlnameSafe(col);
            // ensure unique col2
            col2 = col;
            while (true) {
                if (!set.has(col2)) {
                    set.add(col2);
                    return col2;
                }
                ii += 1;
                col2 = col + ii;
            }
        }).join(" TEXT NOT NULL DEFAULT '',\n") + " TEXT NOT NULL DEFAULT ''\n";
        rowList = "('" + rowList.map(function (row) {
            return row.join("\r");
        }).join("\n").replace((
            /'/g
        ), "''").replace((
            /\r/g
        ), "','").replace((
            /\n/g
        ), "'),\n('") + "');\n";
        sqlPostMessage({
            sql: (`
BEGIN TRANSACTION;
DROP TABLE IF EXISTS tmp1;
CREATE TEMP TABLE tmp1 (
${colList}
);
INSERT INTO tmp1 VALUES
${rowList}
DROP TABLE IF EXISTS tmp_csv1;
CREATE TABLE tmp_csv1 AS SELECT * FROM tmp1;
DROP TABLE tmp1;
COMMIT;
            `)
        });
        onDbRefresh({});
    }

    async function onDbExec({
        data,
        sql
    }) {
    /*
     * this function will
     * 1. exec <sql>-command in webworker
     * 2. ui-render result to html
     */
        // 1. exec <sql>-command in webworker
        uiLoaderEnd({
            modeForce: true
        });
        uiLoaderStart({
            msg: "sql editor - execute",
            modeForce: true
        });
        sql = sql || sqlEditor.getValue() + ";";
        try {
            data = await sqlPostMessage({
                action: "exec",
                sql
            });
        } catch (ignore) {
            onDbRefresh({});
            return;
        }
        // 2. ui-render result to html
        await uiRenderSqlResultIi({
            sqlResultIi: 1,
            tableList: data.tableList
        });
        onDbRefresh({});
    }

    async function onDbOpen({
        target
    }) {
    /*
     * this function will open db from file
     */
        if (target.type !== "file") {
            document.querySelector("#dbFile1").value = "";
            document.querySelector("#dbFile1").click();
            return;
        }
        if (target.files.length === 0) {
            return;
        }
        await sqlPostMessage({
            action: "open",
            data: (
                await target.files[0].arrayBuffer()
            )
        });
        onDbRefresh({});
    }

    onDbRefresh = uiRenderError(async function onDbRefresh({
        data,
        promiseWait,
        table0,
        tableList,
        tmp
    }) {
    /*
     * this function will
     * 1. query tables and indices from db
     * 2. ui-render tables and indices to html
     */
        // 1. query tables and indices from db
        promiseWait = new Promise(function (resolve) {
            setTimeout(resolve, 500);
        });
        // query-info - sqlite_schema
        data = await sqlPostMessage({
            sql: (`
SELECT type AS t_type, name AS t_name, tbl_name, sql AS t_sql
FROM sqlite_schema
WHERE sql IS NOT NULL
ORDER BY tbl_name, type DESC, name;
            `)
        });
        tableList = Array.from(
            data.tableList.length === 0
            ? []
            : data.tableList[0].rowList
        ).map(function ([
            t_type, t_name, tbl_name, t_sql
        ]) {
            let table;
            table = {
                t_name,
                t_sql,
                t_type,
                tbl_name,
                i_list: []
            };
            if (t_type === "index") {
                table0.i_list.push(table);
            }
            if (t_type === "table") {
                table0 = table;
            }
            return table;
        });
        // query-info - colList, rowcount
        tmp = await sqlPostMessage({
            sql: tableList.map(function ({
                t_name,
                t_type
            }) {
                return (
                    t_type === "index"
                    ? "SELECT NULL;\nSELECT NULL;\n"
                    : (
                        "PRAGMA table_info(\"" + t_name + "\");\n" +
                        "SELECT COUNT(*) AS rowcount FROM \"" + t_name + "\";\n"
                    )
                );
            }).join("")
        });
        tableList.forEach(function (result, ii) {
            if (result.t_type === "table") {
                Object.assign(result, {
                    colList: tmp.tableList[2 * ii].rowList.map(function ([
                        ignore, name
                    ]) {
                        return name;
                    }),
                    rowcount: tmp.tableList[2 * ii + 1].rowList[0][0],
                    // [cid, name, type, notnull, dflt_value, pk]
                    table_info: jsonRowListUnnormalize({
                        colList: tmp.tableList[2 * ii].colList,
                        rowList: tmp.tableList[2 * ii].rowList
                    })
                });
            }
        });
        // 2. ui-render tables and indices to html
        await Promise.all([
            promiseWait, uiRenderSqlResultIi({
                sqlResultIi: 2,
                tableList
            })
        ]);
        uiLoaderEnd({});
    });

    async function onDbSave({
        data,
        elem,
        file = "sql-db.db"
    }) {
    /*
     * this function will save db to file
     */
        uiLoaderStart({});
        if (data === undefined) {
            data = await sqlPostMessage({
                action: "export"
            });
            data = data.buffer;
        }
        elem = document.createElement("a");
        elem.href = URL.createObjectURL(new Blob([
            data
        ]));
        elem.download = file.replace(".", "-" + new Date().toISOString() + ".");
        elem.onclick = function () {
            setTimeout(function () {
                URL.revokeObjectURL(elem.href);
            }, 15000);
        };
        uiLoaderEnd({});
        elem.click();
    }

    onDbCrud = uiRenderError(async function onDbCrud({
        colList = [],
        crud = "",
        data,
        i_list = [],
        modeConfirm,
        rowList,
        sql,
        t_name = "",
        t_sql = "",
        t_type = "",
        tmp
    }) {
    /*
     * this function will run <crud>-action on db
     */
        function tableRename({
            i_name,
            i_name2,
            t_name,
            t_name2,
            t_sql
        }) {
        /*
         * this function will replace <t_name> with <t_name2> in <t_sql>
         */
            [
                [
                    i_name, i_name2
                ],
                [
                    t_name, t_name2
                ]
            ].forEach(function ([
                aa, bb
            ]) {
                // replace aa with bb
                if (aa) {
                    t_sql = t_sql.replace(new RegExp(
                        "\\s+?[\"\\[']?" +
                        stringRegexpEscape(aa) +
                        "\\b[\"\\]']?"
                    ), "\n    \"" + bb + "\"\n");
                }
            });
            // normalize t_sql
            return t_sql.replace((
                /[\r\n]+/g
            ), "\n").trim() + ";\n";
        }
        uiLoaderEnd({
            modeForce: true
        });
        // modal - confirm
        if (modeConfirm) {
            await sqlPostMessage({
                // ui-render sql-template from .inputDbCrud-xxx
                sql: document.querySelector(
                    "#datatables_buttons_info textarea"
                ).value.replace((
                    /"\{\{([_a-z]*?)\}\}"/g
                ), function (match0, identifier) {
                    document.querySelectorAll(
                        ".inputDbCrud-" + identifier + " input, " +
                        ".inputDbCrud-" + identifier + " select"
                    ).forEach(function (elem) {
                        match0 = "\"" + (
                            elem.tagName === "SELECT"
                            ? elem.selectedOptions[0].value
                            : elem.value
                        ) + "\"";
                    });
                    return match0;
                })
            });
            await onDbRefresh({});
            return;
        }
        // modal - ui-render
        crud = t_type + " - " + crud;
        tmp = Math.random().toString(16).slice(2);
        switch (crud) {
        case "result - save to csv":
            data = jsonRowListToCsv({
                colList,
                rowList
            });
            await onDbSave({
                data,
                file: "sql-result.csv"
            });
            return;
        case "table - save to csv":
            data = await sqlPostMessage({
                sql: "SELECT * FROM \"" + t_name + "\";\n"
            });
            data = jsonRowListToCsv(data.tableList[0]);
            await onDbSave({
                data,
                file: "sql-table.csv"
            });
            return;
        }
        String(`
-- index - drop
DROP INDEX
    "{{t_name}}";

-- index - rename
DROP INDEX
    "{{t_name}}";
` + tableRename({
            t_name,
            t_name2: "{{new_index}}",
            t_sql
        }) + `;

-- table - add column
ALTER TABLE
    "{{t_name}}"
ADD
    "{{new_column}}" TEXT NOT NULL DEFAULT '';

-- table - add index
CREATE
    -- UNIQUE
INDEX
    "{{new_index}}"
ON "{{t_name}}" (
    "{{selected_column}}"
);

-- table - clone data
CREATE TABLE
    "{{new_table}}"
AS SELECT * FROM
    "{{t_name}}";

-- table - clone data, schema, index
` + tableRename({
            t_name,
            t_name2: "{{new_table}}",
            t_sql
        }) + i_list.map(function ({
            t_name,
            t_sql,
            tbl_name
        }) {
            return tableRename({
                i_name: t_name,
                i_name2: t_name + "_" + tmp,
                t_name: tbl_name,
                t_name2: "{{new_table}}",
                t_sql
            });
        }).join("") + `;
INSERT INTO
    "{{new_table}}"
SELECT * FROM
    "{{t_name}}";

-- table - create
CREATE TABLE
    "{{new_table}}"
(
    "id" INTEGER NOT NULL PRIMARY KEY,
    "column_real" REAL NOT NULL DEFAULT 0.0,
    "column_text" TEXT NOT NULL DEFAULT '',
    "column_blob" BLOB
);

-- table - drop
DROP TABLE
    "{{t_name}}";

-- table - rename
ALTER TABLE
    "{{t_name}}"
RENAME TO
    "{{new_table}}";

-- table - rename column
ALTER TABLE
    "{{t_name}}"
RENAME
    "{{selected_column}}"
TO
    "{{new_column}}";
        `).split("\n\n").some(function (match0) {
            match0 = match0.trim();
            if (match0.indexOf("-- " + crud + "\n") === 0) {
                sql = match0.replace((
                    /\{\{t_name\}\}/g
                ), t_name).replace((
                    /\{\{t_type\}\}/g
                ), t_type);
                return true;
            }
        });
        assertOrThrow(sql, "invalid crud-action " + JSON.stringify(crud));
        colList = colList.map(function (key) {
            return (
                "<option value=\"" + stringHtmlSafe(key) + "\">" +
                stringHtmlSafe(key) +
                "<\/option>\n"
            );
        }).join("");
        uiLoaderInfo(crud, (`
<div>
    <table>
    <tbody>
    <tr class="inputDbCrud-new_table">
        <td><span>"{{new_table}}"<\/span><\/td>
        <td><input type="text" value="new_table_1"><\/td>
    <\/tr>
    <tr class="inputDbCrud-new_index">
        <td><span>"{{new_index}}"<\/span><\/td>
        <td><input type="text" value="new_index_1"><\/td>
    <\/tr>
    <tr class="inputDbCrud-selected_column">
        <td>
            <span>"{{selected_column}}"<\/span>
        <\/td>
        <td>
            <select type="text" value="selected_column_1">${colList}<\/select>
        <\/td>
    <\/tr>
    <tr class="inputDbCrud-new_column">
        <td><span>"{{new_column}}"<\/span><\/td>
        <td><input type="text" value="new_column_1"><\/td>
    <\/tr>
    <\/tbody>
    <\/table>
<\/div>
<div>
    <div>inspect and/or edit sql, then click "ok"<\/div>
    <textarea>${stringHtmlSafe(sql)}<\/textarea>
<\/div>
<div>
    <button id="dbCrudConfirm1" class="button">ok<\/button>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <button id="dbCrudCancel1" class="button">cancel<\/button>
<\/div>
        `));
        uiLoaderInfo = noop;
        // modal - vertical-center
        setTimeout(function () {
            document.querySelectorAll(
                "#datatables_buttons_info"
            ).forEach(function (elem) {
                elem.style.marginTop = -(0.5 * elem.clientHeight + 20) + "px";
            });
        }, 10);
        sql.replace((
            /"\{\{([_a-z]*?)\}\}"/g
        ), function (ignore, identifier) {
            document.querySelectorAll(
                ".inputDbCrud-" + identifier
            ).forEach(function (elem) {
                elem.style.display = "table-row";
            });
            return "";
        });
        // init evt-handling
        [
            [
                "#dbCrudCancel1", "click", uiLoaderEnd.bind(undefined, {
                    modeForce: true
                })
            ],
            [
                "#dbCrudConfirm1", "click", onDbCrud.bind(undefined, {
                    modeConfirm: true
                })
            ],
            [
                "#dbCrudConfirm1", "click", uiLoaderStart.bind(undefined, {
                    modeForce: true
                })
            ]
        ].forEach(function ([
            selector, evt, cb
        ]) {
            document.querySelector(selector).addEventListener(evt, cb);
        });
    });

    // init $
    $.prototype.datatable = $.prototype.DataTable;
    // init uiLoaderInfo
    uiLoaderInfo = $("#uiLoader1").datatable({
        dom: ""
    }).buttons;
    uiLoaderInfo = uiLoaderInfo.info.bind(uiLoaderInfo);
    uiLoaderInfo0 = uiLoaderInfo;
    uiLoaderStart({});
    // init sqlWorker
    sqlCallbackDict = {};
    sqlCallbackId = 1;
    sqlResultDict = {};
    sqlWorker = new Worker("assets.sqljs-v1.4.0.js?initSqlJsWorker=1");
    sqlWorker.onmessage = sqlOnMessage;
    sqlPostMessage({
        action: "open"
    });
    document.querySelector("#dbExec1").onclick = onDbExec;
    // init sqlEditor
    sqlEditor = CodeMirror.fromTextArea(document.querySelector(
        "#editor1 textarea"
    ), {
        extraKeys: {
            "Ctrl-Enter": onDbExec,
            "Ctrl-S": onDbSave.bind(undefined, {}),
            Tab: function (cm) {
                cm.replaceSelection(
                    new Array(cm.getOption("indentUnit") + 1).join(" ")
                );
            }
        },
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        mode: "text/x-mysql"
    });
    // init evt-handling
    [
        [
            "#csvFile1", "change", onCsvOpen
        ],
        [
            "#csvOpen1", "click", onCsvOpen
        ],
        [
            "#dbFile1", "change", onDbOpen
        ],
        [
            "#dbOpen1", "click", onDbOpen
        ],
        [
            "#dbRefresh1", "click", onDbRefresh
        ],
        [
            "#dbSave1", "click", onDbSave.bind(undefined, {})
        ],
        [
            "#dbTableCreate1", "click", onDbCrud.bind(undefined, {
                crud: "create",
                t_type: "table"
            })
        ],
        [
            "body", "click", onContextmenu
        ],
        [
            "body", "click", uiHashtagScrollto
        ],
        [
            "body", "keydown", uiLoaderEnd
        ],
        [
            "body", "contextmenu", onContextmenu
        ]
    ].forEach(function ([
        selector, evt, cb
    ]) {
        document.querySelector(selector).addEventListener(evt, cb);
    });
    // style - validate
    setTimeout(domStyleValidate, 1000);
    // export
    Object.assign(window, {
        domStyleValidate,
        onDbCrud,
        sqlEditor,
        sqlPostMessage,
        sqlResultDict,
        uiLoaderInfo,
        uiRenderError
    });
    // init sqlDb
    await(async function () {
        let sqlDb;
        sqlDb = (
            /\bsqlDb=([^&]+)/
        ).exec(location.search);
        sqlDb = sqlDb && sqlDb[1];
        if (!sqlDb) {
            return;
        }
        sqlDb = await fetch(sqlDb);
        sqlDb = await sqlDb.arrayBuffer();
        await sqlPostMessage({
            action: "open",
            data: sqlDb
        });
    }());
    // init sqlScript
    await(async function () {
        let sqlScript;
        sqlScript = (
            /\bsqlScript=([^&]+)/
        ).exec(location.search);
        sqlScript = sqlScript && sqlScript[1];
        if (!sqlScript) {
            return;
        }
        sqlScript = await fetch(sqlScript);
        sqlScript = await sqlScript.text();
        sqlEditor.setValue(sqlScript);
    }());
    // db - exec
    await onDbExec({});
});
</script>
</body>
</html>
